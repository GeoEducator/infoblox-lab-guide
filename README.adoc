= Ansible Infoblox NIOS Lab Guide
:source-highlighter: rouge

Infoblox NIOS is the leading enterprise DNS, DHCP, IPAM (DDI) solution.  This guide will use the Ansible Infoblox NIOS Lab in RHDPS to demonstrate the automation of IP Administration with NIOS and the Red Hat Ansible Automation Platform.

TIP: For a thorough description of the lab environment, please refer to the AgnosticD config link:https://github.com/redhat-cop/agnosticd/tree/development/ansible/configs/ansible-infoblox[README]

TIP: A video overivew  of the lab environment is available on link:https://www.youtube.com/watch?v=86qaaHzw01Y[Youtube]

== Prerequisites

* Ability to deploy labs in the Red Hat Product Demo System (RHPDS)
* A general understanding of IPv4 subnetting is helpful, but not required to complete the lab
* Familiarity with Tower and Ansible are helpful

== Topics covered

1. Lab overview
2. Initial login to NIOS
3. Overview of the Ansible Tower environment
4. Sample playbook
5. Deploying a project in Ansible Tower
6. Verifying changes in NIOS

== Lab Overview

This lab is deployed in RHDPS by the user or a lab instructor.  Once deployed, you will recieve login credentials for each host in the lab.  Each host can be accessed via a URL and has https and ssh open to the Intneret.  For this guide, we will be accessing the hosts by https. We'll start by logging into each host to verify connectivity and understand the lab environment.

=== Lab Hosts:

1. Infoblox NIOS 8.5.1
2. RHEL 7 bastion running vscode
3. Ansible Tower 3.8

==== NIOS Initial Login

The lab deploys NIOS with several temporary licenses.  On initial login, you will need to accept a EULA, opt in/out of a customer experience program, and finally, close out a Grid Setup Wizard.  

---
Login to NIOS by opening the url providing by the lab deployment.

image::images/infoblox-grid-login.png[]

---
Accpet the EULA

image::images/infoblox-grid-eula.png[]

---
Opt in/out of the customer experience program

image::images/infoblox-grid-cep.png[]

---
Close the Grid Setup Wizard

image::images/infoblox-grid-wizard.png[]
---

=== vscode

vscode is an easy to learn code editor.  It has support for many extensions, including Ansible code highlighitng.  This makes debugging Ansible much easier.  

---
First, login to vscode with the provided credentials

image::images/vscode-login.png[]

---
Next, open the /home/devops folder

image::images/vscode-open-folder1.png[]

image::images/vscode-open-folder2.png[]

---
We can open a Terminal right in vscode. On the toolbar, go to Terminal, New Terminal. You can use this terminal to test playbooks before running them in Tower.

image::images/vscode-new-terminal.png[]

=== Ansible Tower 3.8
---

Ansible Tower is a powerful WEB UI for Ansible.  It provides role-based access control, scheduling, centralized logging of jobs, and many other benefits.

Tower is pre-populatd with several assets you will need to run jobs with NIOS.  Let's login to Tower and review before we start our first project.

Login to Tower

image::images/tower-login.png[]

---
Once logged in, use the left hand navigation pane to select Administration, then Custom Credentials.  Then choose NIOS Custom Credentials

This Custom Credential allows us to pass `nios_grid_username` and `nios_grid_password` to our playbooks as extra vars.  This will be covered in more depth later in the guide.

For now, just be aware that these variables are defined in the custom credential

image::images/tower-custom-creds.png[] 

---
Next, navigate to Resources, Credentials, then `nios creds`.  This is a credential of type `NIOS Custom Credentials` that has the NIOS username and password already defined. We'll use this as our credential in any Job Templates we create.

image::images/tower-creds.png[]

---
Finally, navigate to Resources, Inventory, then `nios`.  This inventory is pre-populated with several important variables. We will use this for our inventory for any jobs we create so the variables are automatically passed to our playbooks.

[options="header,footer"]
|=======================
|Variable           |Definition 
|wapi_version       | defaults to 2.11.1 
|ansible_python_interpreter |/usr/bin/python3 
|nios_grid_url      |public url used for API calls 
|nios_grid_ip       |private IP of the NIOS server 
|=======================


image::images/tower-inventory.png[]

== NIOS Primer

NIOS has two primary network object types. Containers and Networks. Containers are special objects in NIOS that can be further divided. These divisions help to ogranize the IP addresses within NIOS.  We can create containers within containers, or create network objects, assign hosts, etc.  Network objects can have DHCP scopes assigned to them and cannot be further subnetted.

For instance, many organizations use RFC1918 IP addresses for their internal IP space.  We can use Ansible to create a 10.0.0.0/8 container in NIOS for us and then further divide that as needed.  In fact, when you logged into NIOS you have may have noticed that the 10.0.0.0/8 container was already there.  It was added during lab deployment.  

NIOS is configured via an API. In order for our bastion and Tower to communicate with this API, we need the `infoblox-client` python library installed. To avoid python incompatibiltity issues, this has been done for you in a python virtual environment.  In Tower, we'll use this python environment for all our jobs. This will be covered later. 

WARNING: You must run the following command in the terminal to activate the python virtual environment on the bastion:  
 `source /var/lib/awx/venv/nios/bin/activate`


== Lab Example

For this lab, we'll add a new container within 10.0.0/8.  Ansible will query NIOS for the next available container within a parent container and then create the container for us.  

Let's go back to vscode and create a playbook that adds a new network container to NIOS.  


TIP: For this next step it does not matter if you are in the virtualenv or not.  

TIP: You can create your own git repo instead of using the sample repo.

In the vscode terminal,  clone the repo.

WARNING: Be sure to update the playbook with the correct url if you created your own repo.

[source,shell]
----
$ git clone https://github.com/gejames/nioslab.git
$ cd nioslab/
----

In the file explorer window in vscode, click on the new_network.yml file.  

It should look like this.

image::images/vscode-new-network-example.png[]

Next, take note of the `collections/requirements.yml` file. This file will be used be Tower to download the infoblox.nios_modules collection. Be sure to inlude this file in any projects you create.

[source,yaml]

collections:
  - infoblox.nios_modules




NOTE: For reference, the repo is link:https://github.com/gejames/nioslab/[here]

Now we can put the pieces together and add our playbook to Tower as a new Project and Job Template.

Log back into Tower and navigate to Resources/Projects.  Click on the image:images/tower-plus.png[] symbol to create a new Project

1. Give your project a name. NIOS Lab
2. For SCM Type, use Git
3. Paste in the URL for your repo.  https://github.com/gejames/nioslab.git
4. Use /var/lib/awx/venv/nios for your ansible environment. This will become the Default for any jobs we create with this project.
5. Save your project.

image::images\tower-new-project.png[]


Next, go to Resources/Templates, and click on image:images/tower-plus.png[] to create a new Job Template.

1. Name your new job
2. Job type is Run
3. inventorry: nios
4. Project: NIOS Lab
5. Playbook: new_container.yml
6. Credentials: nios creds.  

Save your project by cliking the Save button.

image::images\tower-job-template.png[]



WARNING: To pick `nios creds` you must first change the Credential Type to NIOS Custom Credentials. image:images\tower-job-cred-type.png[]

---
Press the Launch button to start your job.

First, The playbook will reach out to NIOS and ask for the next available network in the defined parent container. cidr is a variable that defines what size subnet we want the container to be.  Due to the way cidr notiation works, this number must be larger then the container cidr.  In thise case the parent container is a /8 and we are asking for a /16. 

[source,yaml]

vars:
   parent_container: 10.0.0.0/8
   cidr: 16

[source,yaml]  
- name: return next available network
      set_fact:
        networkaddr: "{{ lookup('infoblox.nios_modules.nios_next_network', parent_container, cidr=cidr, provider=nios_provider) }}"

The next available network will be returned in cidr notation, for example 10.0.0.0/16

The playbook will then use the `infoblox.nios_modules.nios_network` module to creat that container.

[source,yaml]
 - name: configure a network container in nios
      infoblox.nios_modules.nios_network:
        network: "{{ networkaddr[0] }}"
        container: true
        comment: Created by Ansible NIOS Lab deployment
        state: present
        provider: "{{ nios_provider }}"

Now that we know how to create a new container in NIOS with Ansible, let's give that ability to a junior admin. They aren't entrusted with the keys to the kingdom yet, so we'll put some constraints around them and allow them to create new NIOS containers or networks through a Tower survey.

We can add a survey to our existing job. We just need to change the playbook in our job from new_network.yml to 
 